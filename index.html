<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nigeria PAYE Auto-Scan Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,sans-serif;
  background:#f1f5f9;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  background:#fff;
  max-width:600px;
  width:100%;
  padding:24px;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.12);
}
button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  background:#2563eb;
  color:#fff;
  font-weight:600;
}
button.secondary{background:#0f766e;}
video, img{
  width:100%;
  border-radius:12px;
  margin-top:10px;
}
.result{
  background:#f1f5f9;
  padding:14px;
  margin-top:14px;
  border-radius:12px;
}
.hidden{display:none;}
.good{color:#15803d;font-weight:600;}
.bad{color:#b91c1c;font-weight:600;}
</style>
</head>

<body>

<div class="card">
<h2>ðŸ‡³ðŸ‡¬ PAYE Auto-Scanner</h2>
<p>Hands-free payslip scanning with auto-crop</p>

<button class="secondary" onclick="startAutoScan()">ðŸ“· Start Auto-Scan</button>
<button onclick="stopCamera()">âœ– Stop Camera</button>

<video id="video" autoplay playsinline class="hidden"></video>
<img id="preview" class="hidden">

<div class="result" id="result"></div>
</div>

<canvas id="canvas" class="hidden"></canvas>

<script>
/* ================= TAX LOGIC ================= */
const EXEMPT = 800000;
const BANDS = [
  {limit:2200000, rate:0.15},
  {limit:9000000, rate:0.18},
  {limit:13000000, rate:0.21},
  {limit:25000000, rate:0.23},
  {limit:Infinity, rate:0.25}
];
function computeNewPAYE(m){
  let a=m*12,t=0;
  if(a>EXEMPT){
    let r=a-EXEMPT;
    for(let b of BANDS){
      let amt=Math.min(b.limit,r);
      t+=amt*b.rate; r-=amt;
      if(r<=0)break;
    }
  }
  return t/12;
}

/* ================= CAMERA ================= */
let stream=null, scanInterval=null, scanned=false;

async function startAutoScan(){
  if(!cv || !cv.imread){
    alert("OpenCV still loading, try again");
    return;
  }

  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"}
  });
  video.srcObject = stream;
  video.classList.remove("hidden");

  scanned=false;
  scanInterval=setInterval(captureAndScan,2000);
}

function stopCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  clearInterval(scanInterval);
  video.classList.add("hidden");
}

/* ================= AUTO-CROP ================= */
function autoCrop(){
  const c=document.getElementById("canvas");
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);

  let src=cv.imread(c);
  let gray=new cv.Mat();
  let blur=new cv.Mat();
  let edge=new cv.Mat();

  cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray,blur,new cv.Size(5,5),0);
  cv.Canny(blur,edge,75,200);

  let contours=new cv.MatVector();
  let hierarchy=new cv.Mat();
  cv.findContours(edge,contours,hierarchy,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE);

  let maxArea=0, bestRect=null;
  for(let i=0;i<contours.size();i++){
    let cnt=contours.get(i);
    let peri=cv.arcLength(cnt,true);
    let approx=new cv.Mat();
    cv.approxPolyDP(cnt,approx,0.02*peri,true);
    if(approx.rows===4){
      let r=cv.boundingRect(approx);
      let area=r.width*r.height;
      if(area>maxArea){maxArea=area; bestRect=r;}
    }
  }

  let cropped=src;
  if(bestRect){
    cropped=src.roi(bestRect);
  }

  cv.imshow("canvas",cropped);

  src.delete();gray.delete();blur.delete();edge.delete();
  contours.delete();hierarchy.delete();

  return new Promise(res=>c.toBlob(res));
}

/* ================= OCR LOOP ================= */
async function captureAndScan(){
  if(scanned) return;

  const blob=await autoCrop();
  preview.src=URL.createObjectURL(blob);
  preview.classList.remove("hidden");

  Tesseract.recognize(blob,"eng").then(({data:{text}})=>{
    const t=text.toUpperCase().replace(/â‚¦|,/g,"");
    const gross=extract(t,["GROSS PAY","TOTAL PAY","GROSS"]);
    const oldPAYE=extract(t,["PAYE","TAX"])||0;

    if(gross){
      scanned=true;
      stopCamera();
      showResult(gross,oldPAYE);
    }
  });
}

/* ================= DISPLAY ================= */
function showResult(gross,old){
  const n=computeNewPAYE(gross);
  const d=old-n;
  result.innerHTML=`
    <b>Gross:</b> â‚¦${gross.toLocaleString()}<br>
    <b>Old PAYE:</b> â‚¦${old.toLocaleString()}<br>
    <b>New PAYE:</b> â‚¦${n.toLocaleString()}<hr>
    ${d>0?`<span class="good">Overpaid â‚¦${d.toLocaleString()}</span>`:
      d<0?`<span class="bad">Underpaid â‚¦${Math.abs(d).toLocaleString()}</span>`:
      `<span class="good">Correct</span>`}
  `;
}

/* ================= HELPERS ================= */
function extract(t,keys){
  for(let k of keys){
    let m=t.match(new RegExp(k+"[^0-9]{0,15}([0-9]{4,9})"));
    if(m) return Number(m[1]);
  }
  return null;
}
</script>

</body>
</html>
